plugins:
  datasette-dashboards:
    verify-marktstammdaten:
      title: My Dashboard
      description: Showing some nice metrics
      layout:
        - [wrong-biomass, wrong-solar]
        - [wrong-location-biomass, wrong-location-wind]
      charts:
        wrong-biomass:
          title: Share of biomass plants that contain erroneuos data
          db: failed_tests
          query: SELECT ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share FROM biomass
          library: metric
          display:
            field: share
            prefix:
            suffix: "%"
        wrong-solar:
          title: Share of solar plants that contain erroneuos data
          db: failed_tests
          query: SELECT ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows FROM metadata WHERE table_name='stg_mastr__solar') * 100, 2) as share FROM solar
          library: metric
          display:
            field: share
            prefix:
            suffix: "%"
        
        wrong-location-wind:
          title: Share of units that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              ' ' AS "wind onshore",
              'district' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '  ' AS "wind onshore",
              'district, DSO approved' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '   ' AS "wind onshore",
              'municipality' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '    ' AS "wind onshore",
              'municipality, DSO approved' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land' AND grid_operator_inspection = 1                         
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: wind onshore, type: nominal }
              y: { field: share, type: quantitative  }
              color: { field: Kategorie, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        wrong-location-biomass:
          title: Share of units that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              ' ' AS biomass,
              'district' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__district'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '  ' AS biomass,
              'district, DSO approved' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '   ' AS biomass,
              'municipality' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' 
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '    ' AS biomass,
              'municipality, DSO approved' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1
                         
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: biomass, type: nominal }
              y: { field: share, type: quantitative  }
              color: { field: Kategorie, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2
        