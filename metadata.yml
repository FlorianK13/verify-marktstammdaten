plugins:
  datasette-dashboards:
    verify-marktstammdaten:
      title: Verifying data in the German Core Energy dataset "Marktstammdatenregister"
      layout:
        - [date-chart, date-chart, date-chart, date-chart]
        - [note-location, note-location, note-location, note-location]
        - [chart-location-wind-power, chart-location-wind, chart-location-solar-power, chart-location-solar]
        - [chart-location-biomass-power, chart-location-biomass, chart-location-hydro-power, chart-location-hydro]
        - [
            wrong-division-number-modules-gross-solar-number,
            wrong-division-number-modules-gross-solar-chart,
            wrong-division-number-modules-gross-solar-chart,
            wrong-division-number-modules-gross-solar-chart
          ]
        - [
            wrong-division-gross-inverter-solar-number,
            wrong-division-gross-inverter-solar-chart,
            wrong-division-gross-inverter-solar-chart,
            wrong-division-gross-inverter-solar-chart
          ]
        - [
            wrong-division-gross-inverter-storage-number,
            wrong-division-gross-inverter-storage-chart,
            wrong-division-gross-inverter-storage-chart,
            wrong-division-gross-inverter-storage-chart
          ]
        - [
            wrong-division-gross-power-solar-area-number,
            wrong-division-gross-power-solar-area-chart,
            wrong-division-gross-power-solar-area-chart,
            wrong-division-gross-power-solar-area-chart
          ]
          
        - [map-wind-location, map-wind-location, map-solar-location, map-solar-location]
        - [wrong-installation-year, wrong-installation-year, wrong-installation-year, wrong-installation-year]
        - [metric-solar-balcony, wrong-balcony-power-chart, wrong-balcony-power-chart, wrong-balcony-power-chart]
        - [metric-wind-hub-height, metric-wind-hub-height, metric-solar-balcony-regex, metric-solar-balcony-regex]
        - [data-license-note, data-license-note, data-license-note, data-license-note]
        - [github-note,github-note,github-note,github-note]
      charts:
        date-chart:
          title: The shown data is from
          db: failed_tests
          query: SELECT download_date from biomass LIMIT 1
          library: metric
          display:
            field: download_date
            prefix:
            suffix:

        note-location:
          library: markdown
          display: |-
            # Location errors
            As a first validation we check if the coordinates of those units actually lie within
            the specified districts and municipalities. Therefore we run a spatial join of unit
            coordinates with the given district boundaries taken from the [Federal Agency for
            Cartography and Geodesy](https://gdz.bkg.bund.de/index.php/default/digitale-geodaten/verwaltungsgebiete.html). 
            To make sure that no mismatching units appear
            due to a low resolution of the boundaries, we introduce a buffer zone of several
            100 meters at each boundary. Units that lie within this buffer zone are
            not counted as mismatch as long as they belong to one of the neighboring districts.
            We separate the results by showing all units, units that were already approved by the DSO,
            and units that are marked as active.

        chart-location-wind:
          title: Share of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '   ' AS "wind onshore",
              'district' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '    ' AS "wind onshore",
              'district, DSO approved' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '      ' AS "wind onshore",
              'municipality' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '        ' AS "wind onshore",
              'municipality, DSO approved' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb' AND grid_operator_inspection = 1
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: wind onshore, type: nominal }
              y: { field: share, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        chart-location-wind-power:
          title: Aggregated Power of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '  ' AS "wind onshore",
              'district' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '   ' AS "wind onshore",
              'district, DSO approved' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '     ' AS "wind onshore",
              'municipality' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb'
             UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '      ' AS "wind onshore",
              'municipality, DSO approved' AS category
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb' AND grid_operator_inspection = 1
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: wind onshore, type: nominal }
              y: { field: power in GW, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        chart-location-biomass-power:
          title: Aggregated Power of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '  ' AS biomass,
              'district' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__district' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '   ' AS biomass,
              'district, DSO approved' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1 and operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '     ' AS biomass,
              'municipality' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '      ' AS biomass,
              'municipality, DSO approved' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1 and operating_status = 'In Betrieb'
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: biomass, type: nominal }
              y: { field: power in GW, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        chart-location-biomass:
          title: Share of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '  ' AS biomass,
              'district' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__district' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '   ' AS biomass,
              'district, DSO approved' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1 and operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '     ' AS biomass,
              'municipality' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '      ' AS biomass,
              'municipality, DSO approved' AS category
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1 and operating_status = 'In Betrieb'

          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: biomass, type: nominal }
              y: { field: share, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        chart-location-solar:
          title: Share of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 3) as share,
              '  ' AS solar,
              'district' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__district' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 3) as share,
              '   ' AS solar,
              'district, DSO approved' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 3) as share,
              '     ' AS solar,
              'municipality' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__municipality' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 3) as share,
              '      ' AS solar,
              'municipality, DSO approved' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'

          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: solar, type: nominal }
              y: { field: share, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        chart-location-solar-power:
          title: Aggregated Power of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(SUM(power_net)/1000000, 4) as "power in GW",
              '  ' AS solar,
              'district' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__district' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power_net)/1000000, 4) as "power in GW",
              '   ' AS solar,
              'district, DSO approved' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power_net)/1000000, 4) as "power in GW",
              '     ' AS solar,
              'municipality' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__municipality' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power_net)/1000000, 4) as "power in GW",
              '      ' AS solar,
              'municipality, DSO approved' AS category
            FROM solar
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'

          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: solar, type: nominal }
              y: { field: power in GW, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        chart-location-hydro-power:
          title: Aggregated Power of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '  ' AS hydro,
              'district' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__district' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '   ' AS hydro,
              'district, DSO approved' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '     ' AS hydro,
              'municipality' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__municipality' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(SUM(power)/1000000, 3) as "power in GW",
              '      ' AS hydro,
              'municipality, DSO approved' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'

          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: hydro, type: nominal }
              y: { field: power in GW, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        chart-location-hydro:
          title: Share of active units in the MaStR that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              '  ' AS hydro,
              'district' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__district' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              '   ' AS hydro,
              'district, DSO approved' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              '     ' AS hydro,
              'municipality' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__municipality' AND operating_status = 'In Betrieb'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              '      ' AS hydro,
              'municipality, DSO approved' AS category
            FROM hydro
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1 AND operating_status = 'In Betrieb'

          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: hydro, type: nominal }
              y: { field: share, type: quantitative }
              color: { field: category, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        map-wind-location:
          title: Map of onshore wind turbines with non-matching coordinates and district
          db: failed_tests
          query: >-
            SELECT
              ROUND(power/1000, 3) as "power in MW",
              district,
              municipality,
              longitude,
              latitude
            FROM wind
            WHERE longitude IS NOT NULL AND latitude IS NOT NULL AND failed_test = 'point_in_area__district' AND position = 'Windkraft an Land' AND operating_status = 'In Betrieb'
          library: map

        map-solar-location:
          title: Map of 2000 largest PV systems with non-matching coordinates and district
          db: failed_tests
          query: >-
            SELECT
              ROUND(power_net, 0) as "power in kW",
              district,
              municipality,
              longitude,
              latitude
            FROM solar
            WHERE longitude IS NOT NULL AND latitude IS NOT NULL AND failed_test = 'point_in_area__district' AND operating_status = 'In Betrieb'
            ORDER BY "power in kW" DESC
            LIMIT 2000
          library: map


        wrong-division-gross-inverter-solar-number:
          title: Share of solar units that have non-matching sizes of inverter and installed PV capacity
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (
                SELECT number_rows FROM metadata WHERE table_name='stg_mastr__solar'
              ) * 100, 2) AS share 
            FROM solar 
            WHERE failed_test = 'column_division__power_gross_power_inverter'
          library: metric
          display:
            field: share
            prefix:
            suffix: "%"

        wrong-division-gross-inverter-solar-chart:
          title: Solar units that have erronous power gross or power inverter
          db: failed_tests
          query: >-
            SELECT 
              power_gross as "Power of installed Modules in kW",
              power_inverter as "Power Inverter in kW",
              power_net as "Net Power in kW"
            FROM solar
            WHERE failed_test = 'column_division__power_gross_power_inverter'
            LIMIT 1000

          library: vega-lite
          display:
            mark: { type: point, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x:
                {
                  field: "Power of installed Modules in kW",
                  type: quantitative,
                  scale: { type: log },
                }
              y:
                {
                  field: "Power Inverter in kW",
                  type: quantitative,
                  scale: { type: log },
                }
              size: { field: "Net Power in kW", type: quantitative }

        wrong-division-gross-inverter-storage-number:
          title: Share of storage units that have non-matching sizes of inverter and storage power
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (
                SELECT number_rows FROM metadata WHERE table_name='stg_mastr__storages'
              ) * 100, 2) AS share 
            FROM storage 
            WHERE failed_test = 'column_division__power_gross_power_inverter'
          library: metric
          display:
            field: share
            prefix:
            suffix: "%"

        wrong-division-gross-inverter-storage-chart:
          title: Storage units that have erronous power gross or power inverter
          db: failed_tests
          query: >-
            SELECT 
              power_gross as "Power of installed Storage in kW",
              power_inverter as "Power Inverter in kW",
              power_net as "Net Power in kW"
            FROM storage
            WHERE failed_test = 'column_division__power_gross_power_inverter'
            LIMIT 1000

          library: vega-lite
          display:
            mark: { type: point, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x:
                {
                  field: "Power of installed Storage in kW",
                  type: quantitative,
                  scale: { type: log },
                }
              y:
                {
                  field: "Power Inverter in kW",
                  type: quantitative,
                  scale: { type: log },
                }
              size: { field: "Net Power in kW", type: quantitative }


        wrong-division-gross-power-solar-area-chart:
          title: Ground mounted PV systems where the utilized area does not match
          db: failed_tests
          query: >-
            SELECT 
              power_gross AS "Power of installed PV system in kW",
              utilized_area AS "Area of the ground mounted PV system in ha",
              power_gross / utilized_area AS "Power per area in kW/ha"             
            FROM solar
            WHERE failed_test = 'column_division__power_gross_utilized_area'
            LIMIT 1000

          library: vega-lite
          display:
            mark: { type: point, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              y:
                {
                  field: "Power of installed PV system in kW",
                  type: quantitative,
                  scale: { type: log },
                }
              x:
                {
                  field: "Area of the ground mounted PV system in ha",
                  type: quantitative,
                  scale: { type: log },
                }
              size: { field: "Power of installed PV system in kW", type: quantitative }
        
        wrong-division-gross-power-solar-area-number:
          title: Share of Ground mounted PV systems where the utilized area does not match
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (
                SELECT number_rows FROM metadata WHERE table_name='solar_ground_mounted'
              ) * 100, 2) AS share 
            FROM solar 
            WHERE failed_test = 'column_division__power_gross_utilized_area'
          library: metric
          display:
            field: share
            prefix:
            suffix: "%"

        wrong-division-number-modules-gross-solar-number:
          title: Share of solar units that have erronous power gross or number modules
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (
                SELECT number_rows FROM metadata WHERE table_name='stg_mastr__solar'
              ) * 100, 2) AS share 
            FROM solar 
            WHERE failed_test = 'column_division__power_gross_number_modules'
          library: metric
          display:
            field: share
            prefix:
            suffix: "%"

        wrong-division-number-modules-gross-solar-chart:
          title: Solar units that have erronous power gross or number modules
          db: failed_tests
          query: >-
            SELECT 
              power_gross as "Power of installed Modules in kW",
              number_of_modules as "Number of modules",
              ROUND(power_gross / number_of_modules, 2) as "Power per module in kW"
            FROM solar
            WHERE failed_test = 'column_division__power_gross_number_modules'
            LIMIT 1000

          library: vega-lite
          display:
            mark: { type: point, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x:
                {
                  field: "Power of installed Modules in kW",
                  type: quantitative,
                  scale: { type: log },
                }
              y:
                {
                  field: "Number of modules",
                  type: quantitative,
                  scale: { type: log },
                }
              size: { field: "Power per module in kW", type: quantitative }

        wrong-installation-year:
          title: Units that were installed to early or where the planned installation year is to far in the future.
          db: failed_tests
          query: >-
            SELECT 
              sum(power_net) as "Power of installed units in kW",
              CAST(installation_year AS INT) AS "Installation year",
              'solar' AS technology
            FROM solar
            WHERE failed_test = 'value_between__installation_year'
            AND "Installation year" < 2023
            GROUP BY "Installation year"
            UNION ALL
            SELECT 
              sum(power) as "Power of installed units in kW",
              CAST(installation_year AS INT) AS "Installation year",
              'wind' AS technology
            FROM wind
            WHERE failed_test = 'value_between__installation_year'
            AND "Installation year" < 2023
            GROUP BY "Installation year"
            UNION ALL
            SELECT 
              sum(power) as "Power of installed units in kW",
              CAST(installation_year AS INT) AS "Installation year",
              'biomass' AS technology
            FROM biomass
            WHERE failed_test = 'value_between__installation_year'
            AND "Installation year" < 2023
            GROUP BY "Installation year"
            UNION ALL
            SELECT 
              sum(power_net) as "Power of installed units in kW",
              CAST(installation_year AS INT) AS "Installation year",
              'battery storage' AS technology
            FROM storage
            WHERE failed_test = 'value_between__installation_year_battery'
            AND "Installation year" < 2023
            GROUP BY "Installation year"
            UNION ALL
            SELECT 
              sum(power) as "Power of installed units in kW",
              CAST(installation_year AS INT) AS "Installation year",
              'hydro' AS technology
            FROM hydro
            WHERE failed_test = 'value_between__installation_year'
            AND "Installation year" < 2023
            GROUP BY "Installation year"
            UNION ALL
            SELECT 
              sum(power) as "Power of installed units in kW",
              CAST(installation_year AS INT) AS "Installation year",
              'combustion' AS technology
            FROM combustion
            WHERE failed_test = 'value_between__installation_year'
            AND "Installation year" < 2023
            GROUP BY "Installation year"

          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x:
                {
                  field: Installation year,
                  type: quantitative,
                  axis: { format: d },
                  scale: {
                    "domain": [1900, 1980]
                  }
                }
              y: { field: Power of installed units in kW, type: quantitative }
              color: { field: technology, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2
        wrong-balcony-power-chart:
          title: Histogram of PV systems that are registered as balcony systems but have a power > 1kW
          db: failed_tests
          query: >-
            SELECT 
              (CAST(power_net AS INTEGER) / 1) * 1 AS "Power in kW",
              COUNT(*) AS "Number"
            FROM 
                solar 
            WHERE failed_test = 'value_between__power_net_balcony'
            AND power_net < 101
            GROUP BY 
                "Power in kW"
            ORDER BY 
                "Power in kW";

          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x:
                {
                  field: "Power in kW",
                  type: quantitative,
                  scale: {
                    domain: [0, 100]
                  }
                }
              y: { field: Number, type: quantitative, scale: { type: log } }
              
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2          

        metric-wind-hub-height:
          title: Number of wind turbines that have a larger rotor radius then hub height
          db: failed_tests
          query: >-
            SELECT 
              COUNT(*) AS value 
            FROM wind 
            WHERE failed_test = 'A_larger_B__hub_height_rotor_diameter'
          library: metric
          display:
            field: value
        
        metric-solar-balcony:
          title: Number of PV balcony systems that have a power larger 1kWp
          db: failed_tests
          query: >-
            SELECT 
              COUNT(*) AS value 
            FROM solar 
            WHERE failed_test = 'value_between__power_net_balcony'
          library: metric
          display:
            field: value

        metric-solar-balcony-regex:
          title: Number of PV systems that have 'balcony' in their name but a power larger 5kW
          db: failed_tests
          query: >-
            SELECT 
              COUNT(*) AS value 
            FROM solar 
            WHERE failed_test = 'regex_limit_value__unit_name_power_net'
          library: metric
          display:
            field: value

        data-license-note:
          library: markdown
          display: |-
            # Data License
            > The data has the license **Datenlizenz Deutschland - Namensnennung - Version 2.0** (DL-DE-BY-2.0).
            Copyright: [Marktstammdatenregister](https://www.marktstammdatenregister.de/MaStR) - Bundesnetzagentur f&uuml;r Elektrizit&auml;t, Gas, Telekommunikation, Post und Eisenbahnen | [DL-DE-BY-2.0](https://www.govdata.de/dl-de/by-2-0)
        
        github-note:
          library: markdown
          display: |-
            # Open Source Software
            > All scripts of this project are openly available at [github](https://github.com/FlorianK13/verify-marktstammdaten).

    erronous-entries-district:
      title: Finden Sie fehlerhafte Eintraege im Marktstammdatenregister
      layout:
        - [markdown-search]
        - [table-wrong-locations]
        - [table-wrong-power]
        - [date-chart]
        - [data-license-note]

      filters:
        Kreisschluessel:
          name: Kreisschluessel
          type: string
          default: 09574
      charts:
        markdown-search:
          library: markdown
          display: |-
            Um fehlerhafte Anlagen im Marktstammdatenregister eines bestimmten Landkreises anzuzeigen,
            geben Sie den f`&uuml;`nfstelligen Landkreisschl`&uuml;`ssel in
            die Suchfelder unten ein. Den Kreisschl&uuml;ssel f`&uuml;`r Ihren Landkreis k`&ouml;`nnen Sie [hier](https://de.wikipedia.org/wiki/Liste_der_Landkreise_in_Deutschland)
            finden. Klicken Sie dann auf "Apply", um die Ergebnisse zu erhalten.

        date-chart:
          title: "Die gezeigten Daten wurden heruntergeladen am:"
          db: failed_tests
          query: SELECT download_date from biomass LIMIT 1
          library: metric
          display:
            field: download_date
            prefix:
            suffix:

        table-wrong-locations:
          title: Anlagen aus dem gewaehlten Landkreis, deren Koordinaten nicht im Landkreis liegen.
          db: failed_tests
          query: >-
            SELECT
              mastr_id as "MaStR-Nr.",
              longitude as "Laengengrad",
              latitude as "Breitengrad",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year  as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Solaranlage' as "Typ"
            FROM solar
            WHERE failed_test = 'point_in_area__district'
              [[ AND district_id = :Kreisschluessel ]]
            UNION ALL
            SELECT
              mastr_id as "MaStR-Nr.",
              longitude as "Laengengrad",
              latitude as "Breitengrad",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year  as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Windkraftanlage' as "Typ"
            FROM wind
            WHERE failed_test = 'point_in_area__district'
              [[ AND district_id = :Kreisschluessel ]]
            UNION ALL
            SELECT
              mastr_id as "MaStR-Nr.",
              longitude as "Laengengrad",
              latitude as "Breitengrad",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year  as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Wasserkraftwer' as "Typ"
            FROM hydro
            WHERE failed_test = 'point_in_area__district'
              [[ AND district_id = :Kreisschluessel ]]
            UNION ALL
            SELECT
              mastr_id as "MaStR-Nr.",
              longitude as "Laengengrad",
              latitude as "Breitengrad",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year  as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Verbrennung' as "Typ"
            FROM combustion
            WHERE failed_test = 'point_in_area__district'
              [[ AND district_id = :Kreisschluessel ]]
            UNION ALL
            SELECT
              mastr_id as "MaStR-Nr.",
              longitude as "Laengengrad",
              latitude as "Breitengrad",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year  as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Biomasse' as "Typ"
            FROM biomass
            WHERE failed_test = 'point_in_area__district'
              [[ AND district_id = :Kreisschluessel ]]
            UNION ALL
            SELECT
              mastr_id as "MaStR-Nr.",
              longitude as "Laengengrad",
              latitude as "Breitengrad",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year  as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Stromspeicher' as "Typ"
            FROM storage
            WHERE failed_test = 'point_in_area__district'
              [[ AND district_id = :Kreisschluessel ]]
            ORDER BY "Installationsjahr" DESC
          library: table

        table-wrong-power:
          title: Anlagen aus dem gewaehlten Landkreis, bei denen die Leistung des Wechselrichters nicht zu der Leistung der Anlage passt. Angaben zu Leistung in kW.
          db: failed_tests
          query: >-
            SELECT
              mastr_id as "MaStR-Nr.",
              power_gross as "Leistung Solarmodule",
              power_inverter as "Leistung Wechselrichter",
              power_net as "Leistung netto",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Solaranlage' as "Typ"
            FROM solar
            WHERE failed_test = 'column_division__power_gross_power_inverter'
              [[ AND district_id = :Kreisschluessel ]]
            UNION ALL
            SELECT
              mastr_id as "MaStR-Nr.",
              power_gross as "Leistung Solarmodule",
              power_inverter as "Leistung Wechselrichter",
              power_net as "Leistung netto",
              district as "Landkreis",
              municipality as "Gemeinde",
              installation_year as "Installationsjahr",
              grid_operator_inspection as "Netzbetreiberpruefung",
              'Stromspeicher' as "Typ"
            FROM storage
            WHERE failed_test = 'column_division__power_gross_power_inverter'
              [[ AND district_id = :Kreisschluessel ]]
            ORDER BY "Gemeinde"
          library: table

        data-license-note:
          library: markdown
          display: |-
            # Data License
            > Die Daten sind unter der Lizenz **Datenlizenz Deutschland - Namensnennung - Version 2.0** (DL-DE-BY-2.0) ver`&ouml;`ffentlicht.
            Copyright: [Marktstammdatenregister](https://www.marktstammdatenregister.de/MaStR) - Bundesnetzagentur f&uuml;r Elektrizit&auml;t, Gas, Telekommunikation, Post und Eisenbahnen | [DL-DE-BY-2.0](https://www.govdata.de/dl-de/by-2-0)
