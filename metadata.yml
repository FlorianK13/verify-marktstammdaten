plugins:
  datasette-dashboards:
    verify-marktstammdaten:
      title: Verifying data in the German Core Energy dataset "Marktstammdatenregister"
      description: Some Description     
      layout:
        - [date-chart, date-chart]
        - [wrong-location-note, wrong-location-note]
        - [wrong-location-biomass, wrong-location-wind]
        - [wrong-location-solar, wrong-location-hydro]
        - [wrong-division-gross-inverter-solar-number, wrong-division-gross-inverter-solar-chart]
        - [data-license-note, data-license-note]
      charts:
        date-chart:
          title: The shown data is from
          db: failed_tests
          query: SELECT download_date from biomass LIMIT 1
          library: metric
          display:
            field: download_date
            prefix:
            suffix:

        wrong-location-note:
          library: markdown
          display: |-
            # Location errors
            Sometimes the coordinates do not match the named district or municipality.
          
        wrong-location-wind:
          title: Share of units that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              ' ' AS "wind onshore",
              'district' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '  ' AS "wind onshore",
              'district, DSO approved' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__district' AND position = 'Windkraft an Land' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '   ' AS "wind onshore",
              'municipality' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__wind') * 100, 2) as share,
              '    ' AS "wind onshore",
              'municipality, DSO approved' AS Kategorie
            FROM wind 
            WHERE failed_test = 'point_in_area__municipality' AND position = 'Windkraft an Land' AND grid_operator_inspection = 1                         
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: wind onshore, type: nominal }
              y: { field: share, type: quantitative  }
              color: { field: Kategorie, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        wrong-location-biomass:
          title: Share of units that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              ' ' AS biomass,
              'district' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__district'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '  ' AS biomass,
              'district, DSO approved' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '   ' AS biomass,
              'municipality' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' 
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__biomass') * 100, 2) as share,
              '    ' AS biomass,
              'municipality, DSO approved' AS Kategorie
            FROM biomass
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1
                         
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: biomass, type: nominal }
              y: { field: share, type: quantitative  }
              color: { field: Kategorie, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2
          
        wrong-location-solar:
          title: Share of units that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 2) as share,
              ' ' AS solar,
              'district' AS Kategorie
            FROM solar
            WHERE failed_test = 'point_in_area__district'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 2) as share,
              '  ' AS solar,
              'district, DSO approved' AS Kategorie
            FROM solar
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 2) as share,
              '   ' AS solar,
              'municipality' AS Kategorie
            FROM solar
            WHERE failed_test = 'point_in_area__municipality' 
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__solar') * 100, 2) as share,
              '    ' AS solar,
              'municipality, DSO approved' AS Kategorie
            FROM solar
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1
                         
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: solar, type: nominal }
              y: { field: share, type: quantitative  }
              color: { field: Kategorie, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2
        
        wrong-location-hydro:
          title: Share of units that have missmatching coordinates and adresse.
          db: failed_tests
          query: >-
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              ' ' AS hydro,
              'district' AS Kategorie
            FROM hydro
            WHERE failed_test = 'point_in_area__district'
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              '  ' AS hydro,
              'district, DSO approved' AS Kategorie
            FROM hydro
            WHERE failed_test = 'point_in_area__district' AND grid_operator_inspection = 1
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              '   ' AS hydro,
              'municipality' AS Kategorie
            FROM hydro
            WHERE failed_test = 'point_in_area__municipality' 
            UNION ALL
            SELECT 
              ROUND(CAST(COUNT(DISTINCT(mastr_id)) AS FLOAT) / (SELECT number_rows_with_coordinates FROM metadata WHERE table_name='stg_mastr__hydro') * 100, 2) as share,
              '    ' AS hydro,
              'municipality, DSO approved' AS Kategorie
            FROM hydro
            WHERE failed_test = 'point_in_area__municipality' AND grid_operator_inspection = 1
                         
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: hydro, type: nominal }
              y: { field: share, type: quantitative  }
              color: { field: Kategorie, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2
        
        wrong-division-gross-inverter-solar-number:
          title: Number of solar units that have non-matching sizes of inverter and installed PV capacity
          db: failed_tests
          query: >-
            SELECT COUNT(*) as count from solar 
            WHERE failed_test = 'column_division__power_gross_power_inverter'
          library: metric
          display:
            field: count
            prefix:
            suffix:

        wrong-division-gross-inverter-solar-chart:
          title: Solar units that have erronous power gross or power inverter.
          db: failed_tests
          query: >-
            SELECT 
              power_gross as "Power of installed Modules in W",
              power_inverter as "Power Inverter in W",
              power_net as "Net Power in W"
            FROM solar
            WHERE failed_test = 'column_division__power_gross_power_inverter'
            LIMIT 1000
            
                         
          library: vega-lite
          display:
            mark: { type: point, tooltip: true }
            params:
              - name: highlight
                select: { fields: [source], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: 'Power of installed Modules in W', type: quantitative, scale: {type: log} }
              y: { field: "Power Inverter in W", type: quantitative, scale: {type: log}  }
              size: { field: "Net Power in W", type: quantitative }

        data-license-note:
          library: markdown
          display: |-
            # Data License
            > The data has the license **Datenlizenz Deutschland - Namensnennung - Version 2.0** (DL-DE-BY-2.0).
            Copyright: [Marktstammdatenregister](https://www.marktstammdatenregister.de/MaStR) - Bundesnetzagentur f&uuml;r Elektrizit&auml;t, Gas, Telekommunikation, Post und Eisenbahnen | [DL-DE-BY-2.0](https://www.govdata.de/dl-de/by-2-0)

